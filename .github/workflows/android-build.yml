name: Build Android APK

on:
  push:
    branches: [ "**" ]
  pull_request:
  workflow_dispatch:

concurrency:
  group: android-apk-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Setup JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"
          cache: gradle

      - name: Grant execute permission for Gradle wrapper
        run: chmod +x ./gradlew

      - name: Resolve Gradle tasks (prefer post28)
        id: tasks
        shell: bash
        run: |
          set -euo pipefail

          if ./gradlew -q help --task assemblePost28Debug >/dev/null 2>&1; then
            echo "debug_task=assemblePost28Debug" >> "$GITHUB_OUTPUT"
          else
            echo "debug_task=assembleDebug" >> "$GITHUB_OUTPUT"
          fi

          if ./gradlew -q help --task assemblePost28Release >/dev/null 2>&1; then
            echo "release_task=assemblePost28Release" >> "$GITHUB_OUTPUT"
          else
            echo "release_task=assembleRelease" >> "$GITHUB_OUTPUT"
          fi

          if ./gradlew -q help --task lintPost28Debug >/dev/null 2>&1; then
            echo "lint_task=lintPost28Debug" >> "$GITHUB_OUTPUT"
          else
            echo "lint_task=lintDebug" >> "$GITHUB_OUTPUT"
          fi

      - name: Gradle build (Debug)
        run: ./gradlew --no-daemon --stacktrace ${{ steps.tasks.outputs.debug_task }}

      - name: Gradle lint (Debug)
        run: ./gradlew --no-daemon --stacktrace ${{ steps.tasks.outputs.lint_task }}

      # Prepare signing:
      # - If secrets exist: decode provided keystore
      # - Else: generate a temporary keystore so Release APK is installable for testing
      - name: Prepare signing (provided or generated)
        shell: bash
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
          ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
        run: |
          set -euo pipefail

          KEYSTORE_FILE=/tmp/ci-keystore.jks

          if [ -n "${ANDROID_KEYSTORE_BASE64:-}" ]; then
            echo "$ANDROID_KEYSTORE_BASE64" | base64 -d > "$KEYSTORE_FILE"
            echo "KEYSTORE_FILE=$KEYSTORE_FILE" >> "$GITHUB_ENV"
            echo "KEYSTORE_PASSWORD=$ANDROID_KEYSTORE_PASSWORD" >> "$GITHUB_ENV"
            echo "KEY_ALIAS=$ANDROID_KEY_ALIAS" >> "$GITHUB_ENV"
            echo "KEY_PASSWORD=$ANDROID_KEY_PASSWORD" >> "$GITHUB_ENV"
            echo "Using provided signing keystore."
          else
            # Generate ephemeral keystore for CI installs (NOT for production distribution)
            keytool -genkeypair -v \
              -keystore "$KEYSTORE_FILE" \
              -storepass "android" \
              -keypass "android" \
              -alias "ci" \
              -keyalg RSA -keysize 2048 -validity 10000 \
              -dname "CN=CI,O=CI,C=US"

            echo "KEYSTORE_FILE=$KEYSTORE_FILE" >> "$GITHUB_ENV"
            echo "KEYSTORE_PASSWORD=android" >> "$GITHUB_ENV"
            echo "KEY_ALIAS=ci" >> "$GITHUB_ENV"
            echo "KEY_PASSWORD=android" >> "$GITHUB_ENV"
            echo "Generated temporary CI signing keystore."
          fi

      - name: Gradle build (Release - signed)
        run: |
          ./gradlew --no-daemon --stacktrace ${{ steps.tasks.outputs.release_task }} \
            -Pandroid.injected.signing.store.file="$KEYSTORE_FILE" \
            -Pandroid.injected.signing.store.password="$KEYSTORE_PASSWORD" \
            -Pandroid.injected.signing.key.alias="$KEY_ALIAS" \
            -Pandroid.injected.signing.key.password="$KEY_PASSWORD"

      - name: Upload APK artifacts
        uses: actions/upload-artifact@v4
        with:
          name: apks-${{ github.sha }}
          path: |
            app/build/outputs/apk/**/debug/*.apk
            app/build/outputs/apk/**/release/*.apk
          if-no-files-found: error
